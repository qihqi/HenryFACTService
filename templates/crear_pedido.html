<html>
    <head>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script src="/static/prod.js"></script>
        <script>
            var pedido = [];
            function prodToDom(row) {
                var p = $("<tr>");
                var codigo_cell = $("<td>");
                var cant_cell = $("<td>");
                var nombre_cell = $("<td>");
                var precio_cell = $("<td>");
                var subtotal_cell = $("<td>");
                codigo_cell.html(row.codigo);
                nombre_cell.html(row.nombre);
                cant_cell.html(row.cant);
                precio_cell.html(row.precio);
                subtotal_cell.html(row.subtotal);
                p.append(codigo_cell);
                p.append(cant_cell);
                p.append(nombre_cell);
                p.append(precio_cell);
                p.append(subtotal_cell);
                return p;
            }

            function clearFields() {
                $('#codigo').val('');
                $('#cantidad').val('');
                $('#nombre').html('');
                $('#precio').html('');
                $('#subtotal').html('');
            }

            $(document).ready(function() {
                $('input#codigo').keypress(function(event) {
                    if (event.which == 13) {
                        var codigo = $(this).val();
                        var url = '/api/alm/' + 1 + '/producto/' + codigo;
                        getRequest(url, function(status, result) {
                            $('#nombre').html(result.nombre);
                            $('#precio').html(displayMoney(result.precio1));
                            $('#cantidad').focus();
                        });
                    }
                });
                $('input#cantidad').keypress(function(event) {
                    if (event.which == 13) {
                        var precio = $('#precio').html();
                        var cant = $(this).val();
                        if (!isNumber(cant)) {
                            alert('Cantidad debe ser un numero');
                            $(this).focus();
                        } else {
                            var subtotal = (precio * cant).toFixed(2);
                            $('#subtotal').html(subtotal);
                            $('#agregar').focus();
                        }
                    }
                });
                $('#agregar').click(function() {
                    var prod = {
                        nombre: $('#nombre').html(),
                        codigo: $('#codigo').val(),
                        precio: $('#precio').html(),
                        cant: $('#cantidad').val(),
                        subtotal: $('#subtotal').html()
                    };
                    if (prod.nombre && prod.cant) {
                        pedido.push(prod);
                        var p = prodToDom(prod);
                        $('#pedido').prepend(p);
                        clearFields();
                        calcTotals();
                        $('#codigo').focus();
                    }
                });
            });

            function calcTotals() {
                var sub = 0;
                var total = 0;
                var iva = 0;
                for (var i in pedido) {
                    var p = pedido[i];
                    sub += parseFloat(p.subtotal);
                }
                iva = (0.12 * sub).toFixed(2);
                total = (sub - iva).toFixed(2);
                $('#iva').html(iva);
                $('span#subtotal').html(sub);
                $('#total').html(total);
            }
        </script>
        <style>
        table {
          width: 100%;
        }
        td.codigo, td.cant, td.button, td.precio, td.subtotal {
          width: 10%;
        }

        td.precio, td.subtotal {
            float:right;
        }
        input {
            width: 100%;
        }
        span.valor {
            min-width: 100px;
            display: inline-block;
        }
        table#pedido {
            border: 1px solid black;
        }
        </style>
    </head>
    <body>
        <table>
            <tr>
                <td colspan="7">Ingresar Producto</td>
            </tr>
            <tr>
                <td class="button"><button>Buscar</button></td>
                <td class="codigo"><input id="codigo" placeholder="Codigo"/> </td>
                <td class="cant"><input id="cantidad" placeholder="Cantidad"/> </td>
                <td id="nombre"></td>
                <td class="precio" id="precio"></td>
                <td class="subtotal" id="subtotal">adlfa</td>
                <td><button id="agregar">Agregar</button></td>
            </tr>
        </table>
        <p>
            Subtotal: <span class="valor" id="subtotal"></span>
            Iva: <span class="valor" id="iva"></span>
            Total: <span class="valor" id="total"></span>
        </p>
        <table id="pedido"></table>
    </body>
</html>
